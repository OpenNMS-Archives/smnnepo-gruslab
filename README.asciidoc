= Gru's Lab
:icons: font

Gru's Lab is a testing and demonstration environment for +SMNepO+.
It simulates a complex network with a central +OpenNMS+ instance and multiple sites having seperated infrastructure and services.

== Functional overview
The following figure describes the test scenario to simulate.

image:images/overview.png[Functional Overview]

=== The Network Operation Center (NOC)
 * Runs an OpenNMS instance
 * Uses ActiveMQ as a messaging server

=== The Store
 * Runs up to 10 nodes
 * Runs one minion (to manage all nodes)
 * Needs a VPN connection to the NOC (reserved)
 * Needs a "public" connection to the internet
 * A node is not reachable from the outside (E.g. the internet or the NOC)
 * All nodes within a store can see/ping each other.

If there are multiple stores, each store is build exactly the same (even the ip addresses match).

Each node must run

  * snmp agent
  * some java application to collect jmx data
  * send traps to NOC

== Technical overview
The environment is simulated virtual machines controlled by http://vagrantup.com[vagrant].
Vagrant is responsible for creating and provisioning the machines and create and wire-up the virtual network.

To simulate the network, internal-only networks between the virtual machines are used.
These networks are not accesible from the host and allow isulation of the transmited data.

There is a network for the NOC containing the OpenNMS installation and a network
for each store containing the OpenNMS minion and some nodes.

The following figure describes this.

image:images/overview2.png[Technical Overview]


=== The transfer network
The transfer network is used to connect the stores to the NOC. It's a bridge
connecting the routers for each side and can be seen as the public internet.

The IP range used for the transfer network is:

  10.10.10.0/24


=== The NOC
The NOC contains the central OpenNMS instance 

The IP range used for the NOc network is:

  172.16.0.0/24

The IP of the NOC router is:

  172.16.0.254 inside
  10.10.10.254 outside

The whole network is reachable from the transfer network.

The Machine running the OpenNMS instance and the OpenNMS dominion has the following IP:

  172.16.0.253


=== Store
A store consists of a router connectiong the store with the transfer network, a
OpenNMS minion VM and N nodes providing data collection targets.

The IP range used for each store is:

  192.168.0.0/24

Whereas each store has the same address range.

The public IP of the store router is:

  192.168.0.254 inside
  10.10.10.n    outside - n is the number of the store

The Machine running the OpenNMS minion has the following IP:

  192.168.1.253


== Preparation

=== OpenNMS VM
In order to get the OpenNMS VM to work it is required that you know how to build OpenNMS from source.
If you do not know how to do this, go link:http://www.opennms.org/wiki/Developing_with_Git[here]

Run this to do a clean build and assembly of OpenNMS

----
./clean.pl && ./compile.pl && ./assemble.pl -Dopennms.home=/opt/opennms
----

Copy the generated opennms-<version>.tar.gz file to opennms, e.g.

----
cp ~/dev/opennms/target/opennms-<version>.tar.gz ~/dev/smnnepo-gruslab/opennms/opennms.tar.gz
----

[NOTE]
The target file name must be `opennms.tar.gz`


== Usage
NOTE: All commands must be executed from the project folder.


=== Starting
To start the whole lab with all machines, the following command can be used:

----
vagrant up
----

To start individual virtual machines, use the following command:

----
vagrant up opennms
vagrant up router
etc.
----


=== Stoping
To shut down all machines from the lab, the following command can be used:

----
vagrant destroy -f
----

To stop individual virtual machines, use the following command:

----
vagrant destroy -f opennms
vagrant destroy -f router
etc.
----
